<style>
  #dynamic_detail {
    margin-bottom: 50px;
  }

  #dynamic_detail.detailAn {
    margin-bottom: 0px;
  }

  #dynamic_detail .dynamic {
    width: 100%;
  }

  #dynamic_detail .dynamic, #dynamic_detail .mu-item {
    background-color: #fff;
    margin-bottom: 10px;
  }

  #dynamic_detail .dynamic_detail {
    background-color: #fff;
    margin-bottom: 10px;
  }

  #dynamic_detail .carfri-tabs {
    margin-top: 8px;
  }

  #dynamic_detail .mu-tabs {
    background-color: #fff;
    color: #000;
  }

  #dynamic_detail .mu-tab-link {
    color: black;
    border-bottom: 1px solid #F1F1F5;
  }

  #dynamic_detail .mu-tab-active {
    color: #f98700;
  }

  #dynamic_detail .mu-tab-link-highlight {
    background-color: #f98700;
  }

  #dynamic_detail .mu-card-header .mu-avatar {
    width: 40px;
    height: 40px;
    margin-right: 6px;
    margin-top: -7px;
  }

  #dynamic_detail .mu-card-header-title .mu-card-title {
    font-size: 16px;
    margin-top: -5px;
  }

  #dynamic_detail .mu-card-header-title .mu-card-sub-title {
    font-size: 12px;
    margin-top: 6px;
  }

  #dynamic_detail .mu-card-title-container {
    padding: 0px;
  }

  #dynamic_detail .mu-card-text {
    font-size: 15px;
    line-height: 18px;
    margin-top: -24px;
    padding-top: 13px;
    padding-bottom: 8px;
  }

  #dynamic_detail .mu-card-actions {
    border-top: 1px solid #F1F1F5;
    border-bottom: 1px solid #F1F1F5;
    padding: 0px;
    /*position: fixed;*/
    /*bottom: 49px;*/
  }

  #dynamic_detail .flex-item {
    text-align: center;
    padding: 0px;
    border-right: 1px solid #F1F1F5;
  }

  #dynamic_detail .flex-item .iconfont {
    font-size: 20px;
    padding-top: 3px;
  }

  #dynamic_detail .col-50 .iconfont.icon-mess {
    font-size: 19px;
  }

  #dynamic_detail .col-50 .iconfont.icon-heart {
    font-size: 14px;
  }

  #dynamic_detail .col-50 .iconfont.icon-heart1 {
    color: #F98700;
    margin-top: 2px;
  }

  #dynamic_detail figure {
    display: inline-block;
  }

  #dynamic_detail .content-img {
    height: 80px;
    margin-left: 10px;
    margin-bottom: 10px;
  }

  #dynamic_detail .content-img img {
    object-fit: cover;
  }

  #dynamic_detail .mu-row {
    margin-left: 10px;
    margin-right: 10px;
  }

  #dynamic_detail .mu-col {
    padding-bottom: 8px;
  }

  #dynamic_detail .comDetail {
    background-color: #fff;
    padding-left: 5px;
    margin-top: 10px;
  }

  #dynamic_detail .comDetail > div {
    padding-bottom: 10px;
    padding-left: 10px;
  }

  #dynamic_detail .title {
    font-size: 16px;
    color: #000;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
    margin-bottom: 8px;
  }

  #dynamic_detail .delete {
    display: inline-block;
    color: #999;
    position: relative;
    right: 0px;
    top: -25px;
  }

  #dynamic_detail .icon-down {
    font-size: 22px;
    position: relative;
    right: -100px;
  }

  #dynamic_detail .delete.deleteAn {
    left: -25%;
  }

  #dynamic_detail .topmark {
    display: inline-block;
    position: relative;
    top: 3px;
  }

  #dynamic_detail .dyncon {
    display: inline-block;
  }

  #dynamic_detail .mu-card-text.comcon {
    padding-left: 65px;
  }

  #dynamic_detail .divider {
    background-color: #999;
    margin-top: 4px;
    height: 2px;
  }

  #dynamic_detail .artcon {
    overflow: hidden;
    overflow-x: hidden;
    width: 100%;
    /*height: 500px;*/
    left: 0px;
    right: 0px;
    bottom: 0px;
    border: 0px;
  }

  #dynamic_detail .artcon.shareMap {
    height: 300px;
  }

  #dynamic_detail .row {
    text-align: center;
    padding-top: 10px;
    background-color: #fff;
    border: solid 1px #F1F1F5;
  }

  #dynamic_detail .row .comment {
    position: fixed;
    bottom: 49px;
    border-right: solid 1px #F1F1F5;
  }

  #dynamic_detail .row .support {
    position: fixed;
    left: 50%;
    bottom: 49px;
  }

  .delPopup {
    width: 100%;
    background-color: #DEDBDE;
    margin-bottom: 1px;
  }

  .delPopup .delBut {
  }

  .delPopupAn {
    width: 100%;
    background-color: #DEDBDE;
    margin-bottom: 50px;
  }

  .delPopupAn .delBut {
    margin-bottom: 10px;
  }

  #dynamic_detail .video-js.vjs-custom-skin {
    height: 240px;
  }

  #dynamic_detail .modelAudioBg {
    width: 100%;
    height: 45px;
    position: absolute;
    bottom: 0px;
    /*left: 7%;*/
    background-color: #fff;
  }

  #dynamic_detail .modelAudioBg label {
    position: relative;
    top: -18px;
    /*left: 5px;*/
  }

  #dynamic_detail .modelAudio {
    display: inline-block;
    width: 60%;
    height: 35px;
    margin-top: 5px;
    margin-left: 15px;
    border: solid 1px #F98700;
    border-radius: 5px;
  }

  #dynamic_detail .playAu, #dynamic_detail .pauseAu {
    margin-top: 5px;
  }

  #dynamic_detail .modelAudio img {
    /*display: inline-block;*/
    margin-left: 100px;
    margin-bottom: 3px;
  }

  #dynamic_detail .isShowAudioError {
    width: 100%;
    height: 45px;
    background-color: #fff;
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.8), rgba(255, 255, 255, 0));
    position: absolute;
    bottom: 0px;
  }

  #dynamic_detail .isShowAudioError div {
    padding-top: 15px;
    text-align: center;
    color: #fff;
    font-size: 1.3em;
  }
</style>
<template>
  <div id="dynamic_detail" v-bind:class="{detailAn: isAndroid}"
       :style="{height: screenHeight + 'px'}">
    <my-header main-text="详情" bg-color="#F7F7F7" text-color="#000">
      <img :src="left" alt="">
    </my-header>
    <div class="dynamic" width="100%">
      <mu-card-header
        :title="dynamicData.fleet ? dynamicData.fleet.name : dynamicData.member.nickname"
        :subTitle="dynamicData.publishDate | sliceDate">
        <mu-avatar
          :src="addPath((dynamicData.fleet ? dynamicData.fleet.head : dynamicData.member.head)) || defaultImg"
          slot="avatar"/>
      </mu-card-header>
      <mu-card-text v-if="dynamicData.spaceType === '0'">
        <span v-if="dynamicData.topics.length > 0" v-for="(item,index) in dynamicData.topics" :key="index"
              style="color: #F98700;">#{{item.content}}#</span>
        <span v-html="dynamicData.content"></span>
      </mu-card-text>
      <mu-card-media>
        <figure v-for="(img,index) in dynamicData.images" :key="index">
          <div :style="{width: imgHeight + 'px', height: imgHeight + 'px', overflow: 'hidden'}"
               class="content-img img-container">
            <img :src="addPath(img)" :width="imgWidth" :height="imgWidth">
          </div>
        </figure>
        <video-player :options="playerOptions" ref="videoPlayer" @play="onPlayerPlay($event)"
                      v-if="dynamicData.videos && dynamicData.videos.length > 0">
        </video-player>
        <audio width="50%" :id="'audio' + this.dynamicData.id" controls
               v-if="dynamicData.audios && dynamicData.audios.length > 0" @play="onPlayerPlay($event)"
               @pause="onPlayerPause($event)">
          <source width="100%" :src="addPath(dynamicData.audios[0])">
        </audio>
        <div class="modelAudioBg" v-if="dynamicData.audios && dynamicData.audios.length > 0">
          <div class="modelAudio">
            <mu-icon class="playAu" value="play_arrow" color="#F98700" v-if="isStart" @click="playAudio()"/>
            <mu-icon class="pauseAu" value="pause" color="#F98700" v-if="!isStart" @click="pauseAudio()"/>
            <img :src="vol" alt="" width="40px" v-for="vol, index in volumeArr" :key="index" v-show="index == showVol">
          </div>
          <label for="">{{ timeLongM }}'{{ timeLongS }}''</label>
        </div>
        <div class="isShowAudioError" v-if="isShowAudioError">
          <div>无法找到此音频兼容的源</div>
        </div>
      </mu-card-media>
      <iframe class="artcon" v-bind:class="{shareMap: dynamicData.share.shareType === '6'}" :height="screenHeight"
              v-if="dynamicData.spaceType === '1'" width="100%"
              :src="addPath(makeUrl)" seamless>
      </iframe>
      <div class="carfri-tabs">
        <mu-divider/>
        <mu-tabs :value="activeTab" @change="handleTabChange">
          <mu-tab value="1" :title="comtit"/>
          <mu-tab value="0" :title="suptit"/>
        </mu-tabs>
      </div>
      <div v-if="activeTab === '1'">
        <div class="dynamic" v-for="(item, index) in dynamicData.comments" :key="index">
          <mu-card-header :title="item.member.nickname" :subTitle="item.commentDatetime | sliceDatecom">
            <mu-avatar :src="addPath(item.member.head) || defaultImg" slot="avatar"/>
            <div class="delete" v-if="item.member.nickname === nickName">
              <i class="iconfont icon-down" @click="open(item.id)"></i>
              <mu-popup position="bottom" :popupClass="isIOS ? 'delPopupAn' : 'delPopup'"
                        :open="item.id === bottomPopup" @close="close()">
                <mu-raised-button class="delBut" label="删除" @click="delCom(item, index)" fullWidth/>
                <mu-raised-button label="取消" @click="close()" fullWidth/>
              </mu-popup>
            </div>
          </mu-card-header>
          <mu-card-text class="comcon">
            <span v-if="dynamicData.topics.length > 0" v-for="(item,index) in dynamicData.topics" :key="index"
                  style="color: #F98700;">#{{item.content}}#</span>
            <span v-html="item.content"></span>
            <mu-divider class="divider"/>
          </mu-card-text>
        </div>
      </div>
      <div v-if="activeTab === '0'">
        <mu-list-item v-for="(item,index) in dynamicData.supports" :key="index" :title="item.member.nickname" disabled>
          <mu-avatar slot="left" :src="addPath(item.member.head) || defaultImg" :size="30"/>
        </mu-list-item>
      </div>
      <!--<mu-row>
        <mu-col width="50" class="comment" v-bind:class="{commentAn: isAndriod}" v-tap="{methods: comment, id: dynamicData.id}">
          <i class="iconfont icon-mess"></i>
          <span class="comNum">评论</span>
        </mu-col>
        <mu-col width="50" class="support" v-bind:class="{supportAn: isAndriod}"v-tap="{methods: support}">
          <i class="iconfont icon-heart"  v-if="dynamicData.isSupport === '0'" ></i>
          <i class="iconfont icon-heart1"  v-if="dynamicData.isSupport === '1'" ></i>
          <span>喜欢</span>
        </mu-col>
      </mu-row>-->
    </div>
  </div>
</template>
<script>
  import myHeader from 'components/my-header'
  import left from 'assets/left-gray.svg'

  import defaultImg from 'assets/default_user_icon.png'
  import volume1 from 'assets/volume1.png'
  import volume2 from 'assets/volume2.png'
  import volume3 from 'assets/volume3.png'
  import volume4 from 'assets/volume4.png'

  let timeBack // 音频
  let auPlayVol // 音频

  export default {
    data () {
      return {
        left,
        defaultImg,
        bottomPopup: '',
        screenWidth: window.screen.width,
        screenHeight: document.documentElement ? document.documentElement.clientHeight : document.body.clientHeight,
        dynamicData: {
          fleet: {},
          nickname: ''
        },
        playerOptions: {
          start: 0,
          playsinline: false,
          muted: true,
          language: 'zh-CN',
          playbackRates: [0.7, 1.0, 1.5, 2.0],
          sources: [{
            src: '',
            type: ''
          }],
          poster: defaultImg
        },
        isStart: true,
        isShowAudioError: false,
        volumeArr: [volume1, volume2, volume3, volume4], // 音量图片
        showVol: 0,
        timeLong: 0,
        timeLongM: 0,
        timeLongS: 0,
        timeBack: null,
        auPlayVol: null,
        activeTab: '1',
        isAndriod: '',
        isIOS: '',
        comtit: '',
        suptit: '',
        nickName: ''
      }
    },

    computed: {
      imgWidth () {
        let width = (this.screenWidth - 28) * 0.33 - 4
        return width
      }
    },
    filters: {
      sliceDate: function (value) {
        if (!value) return ''
        return value.slice(5, 10)
      },
      sliceDatecom: function (value) {
        if (!value) return ''
        return value.slice(5, 16)
      }
    },
    methods: {
      goBack () {
        // this.onPlayerPlay()
        this.$router.go(-1)
        return
      },
      // tab页切换
      handleTabChange (val) {
        this.activeTab = val
      },
      onPlayerPlay (e) {
        // e.target.pause()
      },
      // 打开删除自己评论的弹窗
      open (id) {
        this.bottomPopup = id
      },
      // 关闭删除评论的弹窗
      close () {
        this.bottomPopup = ''
      },
      // 删除评论
      delCom (comData, index) {
        this.$.get({
          methodName: 'DeleteSpaceComment',
          ids: [comData.id]
        }).then(resp => {
          if (resp.data.resultCode === '100') {
            this.dynamicData.commentCount--
            this.comtit = '评论' + ' ' + this.dynamicData.commentCount
            this.dynamicData.comments.splice(index, 1)
            this.bottomPopup = ''
          }
        })
      },
      // 对动态评论
      comment (params) {
        this.$router.push({
          name: 'comment_dynamic',
          params: {
            dynamicId: params.id
          }
        })
      },
      // 对动态点赞
      changeSupport () {
        return this.$.get({
          methodName: 'CreateSpaceSupport',
          spaceId: this.dynamicData.id
        })
      },
      // 点赞触发页面字体图标和数量变化
      support () {
        if (this.dynamicData.isSupport === '0') {
          this.changeSupport().then(resp => {
            if (resp.data.resultCode === '100') {
              this.dynamicData.isSupport = '1'
              this.dynamicData.supportCount++
              this.suptit = '喜欢' + ' ' + this.dynamicData.supportCount
              window.alert(this.dynamicData.isSupport)
            }
          })
        }
        if (this.dynamicData.isSupport === '1') {
          this.changeSupport().then(resp => {
            if (resp.data.resultCode === '100') {
              this.dynamicData.isSupport = '0'
              this.dynamicData.supportCount--
              this.suptit = '喜欢' + ' ' + this.dynamicData.supportCount
              window.alert(this.dynamicData.isSupport)
            }
          })
        }
      },
      playAudio () {
        let id = 'audio' + this.dynamicData.id
        this.isStart = false
        document.getElementById(id).play()
        // 音频播放时图片循环变化
        auPlayVol = setInterval(() => {
          this.showVol++
          if (this.showVol == 3) {
            this.showVol = 0
          }
        }, 500)
        // 音频时间倒数
        function timeFun (vm) {
          vm.timeLong--
          vm.timeLongM = parseInt(vm.timeLong / 60)
          vm.timeLongS = parseInt(vm.timeLong % 60)
          if (vm.timeLong < 1) {
            clearTimeout(timeBack)
            vm.isStart = true
            clearTimeout(auPlayVol)
            let dom = document.getElementById(id)
            vm.timeLong = dom.duration
            vm.timeLongM = parseInt(vm.timeLong / 60)
            vm.timeLongS = parseInt(vm.timeLong % 60)
          }
        }

        timeBack = setInterval(() => {
          timeFun(this)
        }, 1000)
      },
      pauseAudio () {
        let id = window.localStorage.getItem('dynAudioId')
        this.isStart = true
        document.getElementById(id).pause()
        clearTimeout(timeBack)
        clearTimeout(auPlayVol)
      }
    },
    components: {
      myHeader
    },
    mounted () {
      let vm = this
      this.$.get({
        methodName: 'QuerySpace',
        spaceId: this.$route.params.dynamicId
      }).then(resp => {
        if (resp.data.resultCode === '100') {
          let u = navigator.userAgent
          vm.isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1
          vm.isIOS = !vm.isAndroid
          vm.nickName = this.$route.params.usernickName
          vm.dynamicData = resp.data.space
          vm.makeUrl = resp.data.space.share.path + (vm.isAndriod ? '?isAndroid=true' : '?isIos=true')
          vm.comtit = '评论' + ' ' + resp.data.space.commentCount
          vm.suptit = '喜欢' + ' ' + resp.data.space.supportCount
          setTimeout(() => {
            vm.playerOptions.muted = false
          }, 2000)
          if (vm.dynamicData.videos.length > 0) {
            let element = vm.dynamicData.videos[0]
            vm.playerOptions.sources[0].src = vm.addPath(element)
            vm.playerOptions.sources[0].type = 'video/' + element.split('.')[1]
          }
          // 获取音频时长
          vm.$nextTick(() => {
            let id = 'audio' + vm.dynamicData.id
            let dom = document.getElementById(id)
            if (dom) {
              vm.timeLong = 0
              vm.isShowAudioError = true
              vm.audiosDom = dom
              dom.addEventListener("loadeddata", () => {
                vm.timeLong = dom.duration
                vm.timeLongM = parseInt(vm.timeLong / 60)
                vm.timeLongS = parseInt(vm.timeLong % 60)
                vm.isShowAudioError = false
              })
            }
          })
        }
      })
    }
  }
</script>
